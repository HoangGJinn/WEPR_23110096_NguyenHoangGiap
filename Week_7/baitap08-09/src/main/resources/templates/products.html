<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Sản phẩm</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .main-content {
            flex: 1;
        }
        .card {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div th:replace="~{fragments/header :: header}"></div>

    <div class="main-content">
        <div class="container mt-4">
        <!-- Form thêm/sửa sản phẩm -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 id="formTitle">Thêm sản phẩm mới</h5>
            </div>
            <div class="card-body">
                <form id="productForm" novalidate>
                    <input type="hidden" id="productId">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Tiêu đề <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="title" required minlength="3" maxlength="200">
                            <div class="invalid-feedback">Tiêu đề phải từ 3 đến 200 ký tự.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Số lượng <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="quantity" required min="0" max="10000">
                            <div class="invalid-feedback">Số lượng phải từ 0 đến 10,000.</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mô tả</label>
                        <textarea class="form-control" id="desc" rows="3" maxlength="500"></textarea>
                        <small class="text-muted">Tối đa 500 ký tự</small>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Giá <span class="text-danger">*</span></label>
                            <input type="number" step="1000" class="form-control" id="price" required min="0" max="999999999">
                            <div class="invalid-feedback">Giá phải lớn hơn 0 và nhỏ hơn 999,999,999.</div>
                            <small class="text-muted">Đơn vị: VNĐ</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">URL Ảnh</label>
                            <input type="url" class="form-control" id="images" placeholder="https://example.com/image.jpg">
                            <div class="invalid-feedback">URL ảnh không hợp lệ.</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">User ID <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="userid" required min="1">
                        <div class="invalid-feedback">User ID phải lớn hơn 0.</div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> Lưu
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">
                        <i class="bi bi-x-circle"></i> Hủy
                    </button>
                </form>
            </div>
        </div>

        <!-- Tìm sản phẩm theo category -->
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5>Tìm sản phẩm theo Category</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <input type="number" class="form-control" id="categoryIdSearch" placeholder="Nhập Category ID">
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-info" onclick="searchByCategory()">Tìm kiếm</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Danh sách sản phẩm -->
        <div class="card">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5>Danh sách sản phẩm (sắp xếp theo giá từ thấp đến cao)</h5>
                <button class="btn btn-light btn-sm" onclick="loadProducts()">Làm mới</button>
            </div>
            <div class="card-body">
                <div id="productsList"></div>
            </div>
        </div>
    </div>
    </div>

    <div th:replace="~{fragments/footer :: footer}"></div>

    <script>
        const GRAPHQL_URL = '/graphql';

        async function graphqlRequest(query, variables = {}) {
            const response = await fetch(GRAPHQL_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    query: query,
                    variables: variables
                })
            });
            return await response.json();
        }

        async function loadProducts() {
            const query = `
                query {
                    getProductsSortedByPrice {
                        id
                        title
                        quantity
                        desc
                        price
                        userid
                    }
                }
            `;
            
            const result = await graphqlRequest(query);
            if (result.errors) {
                alert('Lỗi: ' + result.errors[0].message);
                return;
            }
            
            const products = result.data.getProductsSortedByPrice;
            displayProducts(products);
        }

        function displayProducts(products) {
            const container = document.getElementById('productsList');
            if (products.length === 0) {
                container.innerHTML = '<p class="text-muted">Không có sản phẩm nào.</p>';
                return;
            }
            
            let html = '<table class="table table-striped"><thead><tr><th>ID</th><th>Tiêu đề</th><th>Số lượng</th><th>Mô tả</th><th>Giá</th><th>User ID</th><th>Thao tác</th></tr></thead><tbody>';
            products.forEach(product => {
                html += `
                    <tr>
                        <td>${product.id}</td>
                        <td>${product.title}</td>
                        <td>${product.quantity}</td>
                        <td>${product.desc || ''}</td>
                        <td>${product.price}</td>
                        <td>${product.userid}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editProduct(${product.id})">Sửa</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteProduct(${product.id})">Xóa</button>
                        </td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function searchByCategory() {
            const categoryId = document.getElementById('categoryIdSearch').value;
            if (!categoryId) {
                alert('Vui lòng nhập Category ID');
                return;
            }
            
            const query = `
                query($categoryId: ID!) {
                    getProductsByCategoryId(categoryId: $categoryId) {
                        id
                        title
                        quantity
                        desc
                        price
                        userid
                    }
                }
            `;
            
            const result = await graphqlRequest(query, { categoryId: parseInt(categoryId) });
            if (result.errors) {
                alert('Lỗi: ' + result.errors[0].message);
                return;
            }
            
            const products = result.data.getProductsByCategoryId;
            displayProducts(products);
        }

        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Validate form
            const form = e.target;
            if (!form.checkValidity()) {
                e.stopPropagation();
                form.classList.add('was-validated');
                return;
            }
            
            const id = document.getElementById('productId').value;
            const title = document.getElementById('title').value.trim();
            const quantity = parseInt(document.getElementById('quantity').value);
            const desc = document.getElementById('desc').value.trim();
            const price = parseFloat(document.getElementById('price').value);
            const images = document.getElementById('images').value.trim();
            const userid = parseInt(document.getElementById('userid').value);

            // Additional validation
            if (title.length < 3 || title.length > 200) {
                alert('Tiêu đề phải từ 3 đến 200 ký tự!');
                return;
            }
            
            if (quantity < 0 || quantity > 10000) {
                alert('Số lượng phải từ 0 đến 10,000!');
                return;
            }
            
            if (price <= 0 || price > 999999999) {
                alert('Giá phải lớn hơn 0 và nhỏ hơn 999,999,999!');
                return;
            }
            
            if (userid < 1) {
                alert('User ID phải lớn hơn 0!');
                return;
            }

            let query, variables;
            if (id) {
                query = `
                    mutation($id: ID!, $title: String, $quantity: Int, $desc: String, $price: Float, $userid: ID) {
                        updateProduct(id: $id, title: $title, quantity: $quantity, desc: $desc, price: $price, userid: $userid) {
                            id
                            title
                        }
                    }
                `;
                variables = { id: parseInt(id), title, quantity, desc, price, userid };
            } else {
                query = `
                    mutation($title: String!, $quantity: Int!, $desc: String, $price: Float!, $userid: ID!) {
                        createProduct(title: $title, quantity: $quantity, desc: $desc, price: $price, userid: $userid) {
                            id
                            title
                        }
                    }
                `;
                variables = { title, quantity, desc, price, userid };
            }

            const result = await graphqlRequest(query, variables);
            if (result.errors) {
                alert('Lỗi: ' + result.errors[0].message);
                return;
            }
            
            alert('Lưu sản phẩm thành công!');
            resetForm();
            loadProducts();
        });

        async function editProduct(id) {
            const query = `
                query($id: ID!) {
                    getProductById(id: $id) {
                        id
                        title
                        quantity
                        desc
                        price
                        userid
                    }
                }
            `;
            
            const result = await graphqlRequest(query, { id });
            if (result.errors) {
                alert('Lỗi: ' + result.errors[0].message);
                return;
            }
            
            const product = result.data.getProductById;
            document.getElementById('productId').value = product.id;
            document.getElementById('title').value = product.title;
            document.getElementById('quantity').value = product.quantity;
            document.getElementById('desc').value = product.desc || '';
            document.getElementById('price').value = product.price;
            document.getElementById('userid').value = product.userid;
            document.getElementById('formTitle').textContent = 'Sửa sản phẩm';
            window.scrollTo(0, 0);
        }

        async function deleteProduct(id) {
            if (!confirm('Bạn có chắc chắn muốn xóa sản phẩm này?')) return;
            
            const query = `
                mutation($id: ID!) {
                    deleteProduct(id: $id)
                }
            `;
            
            const result = await graphqlRequest(query, { id });
            if (result.errors) {
                alert('Lỗi: ' + result.errors[0].message);
                return;
            }
            
            alert('Xóa thành công!');
            loadProducts();
        }

        function resetForm() {
            const form = document.getElementById('productForm');
            form.reset();
            form.classList.remove('was-validated');
            document.getElementById('productId').value = '';
            document.getElementById('formTitle').textContent = 'Thêm sản phẩm mới';
        }

        // Load products on page load
        loadProducts();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
</body>
</html>

